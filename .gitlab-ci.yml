before_script:
  - apt -y install gawk
  - pip install coverage
  - curl -OL https://github.com/lh3/bwa/releases/download/v0.7.15/bwakit-0.7.15_x64-linux.tar.bz2
  - tar -xjf bwakit-0.7.15_x64-linux.tar.bz2
  - export PATH="bwa.kit:$PATH"
  - curl -OL ftp://ftp.lanl.gov/public/genome/GOTTCHA2/RefSeq-Release81/RefSeq-Release81.Virus.species.fna.tar
  - curl -OL ftp://ftp.lanl.gov/public/genome/GOTTCHA2/RefSeq-Release81/taxonomy.tar
  - mkdir database
  - tar -xf RefSeq-Release81.Virus.species.fna.tar -C database
  - tar -xf taxonomy.tar -C database
  - curl -OL ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR155/009/SRR1553609/SRR1553609_1.fastq.gz

functional tests:
  image: continuumio/miniconda3
  script:
# test gottcha_taxonomy.py
    - echo 186538.1 > test_taxid.txt
    - coverage run -p ./gottcha_taxonomy.py < test_taxid.txt
# init test
    - coverage run -p gottcha.py --help
# test modes
    - coverage run -p gottcha.py -d database/RefSeq-Release81.Virus.species.fna -p test_mode -i SRR1553609_1.fastq.gz
    - head test_mode.summary.tsv
    - coverage run -p gottcha.py -m full -d database/RefSeq-Release81.Virus.species.fna -p test_mode -s test.gottcha_species.sam
    - head test_mode.full.tsv
    - coverage run -p gottcha.py -m class -d database/RefSeq-Release81.Virus.species.fna -p test_mode -s test.gottcha_species.sam
    - head test_mode.class.tsv
    - coverage run -p gottcha.py -m lineage -d database/RefSeq-Release81.Virus.species.fna -p test_mode -s test.gottcha_species.sam
    - head test_mode.lineage.tsv
    - coverage run -p gottcha.py -m extract -x 186538 -d database/RefSeq-Release81.Virus.species.fna -p test_mode -s test.gottcha_species.sam
    - head test_mode.extract186538.fastq
# test cutoffs
    - coverage run -p gottcha.py -m full -d database/RefSeq-Release81.Virus.species.fna -p test_cutoff -s test.gottcha_species.sam --noCutoff
    - head test_cutoff.full.tsv
    - coverage run -p gottcha.py -m full -d database/RefSeq-Release81.Virus.species.fna -p test_cutoff -s test.gottcha_species.sam -mc 0.002 -mr 2 -ml 50
    - head test_cutoff.full.tsv
# test relative abundance
    - coverage run -p gottcha.py -m full -d database/RefSeq-Release81.Virus.species.fna -p test_ra -s test.gottcha_species.sam -r ROLLUP_DOC
    - head test_ra.full.tsv
    - coverage run -p gottcha.py -m full -d database/RefSeq-Release81.Virus.species.fna -p test_ra -s test.gottcha_species.sam -r READ_COUNT
    - head test_ra.full.tsv
    - coverage run -p gottcha.py -m full -d database/RefSeq-Release81.Virus.species.fna -p test_ra -s test.gottcha_species.sam -r TOTAL_BP_MAPPED
    - head test_ra.full.tsv
# test multiple threads
    - cat test.gottcha_species.sam test.gottcha_species.sam test.gottcha_species.sam > test.gottcha_species_3x.sam
    - coverage run -p gottcha.py -m full -t 4 -d database/RefSeq-Release81.Virus.species.fna -p test_mt -s test.gottcha_species_3x.sam
    - head test_mt.full.tsv
# coverage report
    - coverage combine
    - coverage report -m